version: 2.1

orbs:
  go: circleci/go@1.8.0
  node: circleci/node@5.2.0
  slack: circleci/slack@4.10.1

commands:
  notify-failures-on-main:
    description: "Notify Slack for CI job failures"
    parameters:
      channel:
        type: string
    steps:
      - slack/notify:
          channel: << parameters.channel >>
          event: fail
          template: basic_fail_1
          branch_pattern: main
  install-just:
    description: "Install just"
    steps:
      - run:
          name: "Install just"
          command: |
            wget -qO - 'https://proget.makedeb.org/debian-feeds/prebuilt-mpr.pub' | gpg --dearmor | sudo tee /usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg 1> /dev/null
            echo "deb [arch=all,$(dpkg --print-architecture) signed-by=/usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg] https://proget.makedeb.org prebuilt-mpr $(lsb_release -cs)" | sudo tee /etc/apt/sources.list.d/prebuilt-mpr.list
            sudo apt update
            sudo apt install just
  install-foundry:
    description: "Installs foundry"
    steps:
      - run:
          # need foundry to execute 'cast call' within add-chain script
          name: Install foundry
          command: |
            echo "SHELL=$SHELL"
            # Set up directory structure
            mkdir -p $HOME/.foundry/bin
            echo 'export PATH="$HOME/.foundry/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

            # Download foundryup and make it executable
            curl -sSL "https://raw.githubusercontent.com/foundry-rs/foundry/master/foundryup/foundryup" -o $HOME/.foundry/bin/foundryup
            chmod +x $HOME/.foundry/bin/foundryup

            $HOME/.foundry/bin/foundryup
            forge --version
  install-gvm:
    description: "Installs gvm"
    steps:
      - run:
          command: |
            apt-get update
            apt-get -yq install curl git mercurial make binutils bison gcc build-essential bsdmainutils
            bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
  validate-genesis:
    description: "Runs genesis validation checks"
    steps:
      - run:
          name: Clone monorepo
          command: mkdir ../optimism-temporary && git clone https://github.com/ethereum-optimism/optimism.git ../optimism-temporary
      - run: just validate-genesis "*"

jobs:
  golang-lint:
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - run: just lint-all
      - run:
          name: check git tree is clean
          command: git diff --exit-code
  golang-modules-tidy:
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - run: just tidy-all
      - run:
          name: check git tree is clean
          command: git diff --exit-code
  golang-test:
    shell: /bin/bash -eo pipefail
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - install-foundry
      - run:
          name: run superchain module unit tests
          command: just test-superchain
      - run:
          name: run validation module unit tests
          command: just test-validation
      - run:
          name: run add-chain module unit tests
          command: just test-add-chain
      - notify-failures-on-main:
          channel: C03N11M0BBN # to slack channel `notify-ci-failures`
  golang-validate-genesis:
    docker:
      - image: us-docker.pkg.dev/oplabs-tools-artifacts/images/ci-builder:v0.49.0
    resource_class: medium
    steps:
      - checkout
      # - install-just
      - install-foundry
      - install-gvm
      - validate-genesis # TODO this should also be filtered on modified chains
  golang-validate-modified:
    shell: /bin/bash -eo pipefail
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - install-foundry
      - run:
          name: run validation checks
          command: just validate-modified-chains main # TODO ideally this is the base branch
  golang-validate-all:
    shell: /bin/bash -eo pipefail
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - install-foundry
      - run:
          name: run validation checks on all chains
          command: just validate "*"
      - notify-failures-on-main:
          channel: C07GQQZDW1G # to slack channel `notify-superchain-validation-failures`
  golang-promotion-test:
    shell: /bin/bash -eo pipefail
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - install-foundry
      - run:
          name: run validation checks
          command: just promotion-test
      - slack/notify:
          event: always
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":control_knobs: The daily report on standard candidate chains is ready!"
                  },
                  "accessory": {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ðŸ‘€ View Report",
                      "emoji": true
                    },
                    "url": "${CIRCLE_BUILD_URL}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Click the link to see what validation checks would fail if all candidate chains were promoted to standard (and exclusions removed)."
                    }
                  ]
                }
              ]
            }
          channel: C07GZVCCUS0 # to slack channel `notify-superchain-promotion-failures`
  publish-bot:
    environment:
      NODE_AUTH_TOKEN: $NPM_TOKEN  # Use NPM_TOKEN as the auth token
    docker:
      - image: cimg/node:18  # Use Node.js 18
    steps:
      - checkout
      - run:
          name: Set deployment token
          command: npm config set '//registry.npmjs.org/:_authToken' "${NPM_TOKEN}"
      - env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      - run:
          name: Build and publish package on NPM ðŸ“¦
          command: pnpm release
  check-codegen:
    executor:
      name: go/default  # is based on cimg/go
      tag: '1.21'
    steps:
      - checkout
      - install-just
      - run:
          name: Run codegen
          command: just codegen
      - run:
          name: check git tree is clean
          command: git diff --exit-code

workflows:
  hourly:
    jobs:
      - golang-validate-all:
          context:
            - slack
      - golang-test:
          context:
            - slack
    triggers:
      - schedule:
          cron: "0 * * * *"
          filters:
            branches:
              only:
                - main
  nightly:
    jobs:
      - golang-promotion-test:
          context:
            - slack
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
  pr-checks:
    jobs:
      - golang-lint
      - golang-modules-tidy
      - golang-test
      - golang-validate-genesis
      - golang-validate-modified
      - check-codegen
