version: 2.1

# This allows us to use CircleCI's dynamic configuration feature
setup: true

parameters:
  chain:
    type: string
    default: "__required__"

orbs:
  continuation: circleci/continuation@0.3.1

jobs:
  setup-genesis-allocs-validation:
    docker:
      - image: alpine:latest
    steps:
      - checkout
      - run:
          name: Install Git, yq, and jq
          command: |
            apk add --no-cache git jq curl
            curl -sLo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            chmod +x /usr/local/bin/yq
      - run:
          name: Verify Git
          command: git --version
      - run:
          name: Verify yq
          command: yq --version
      - run:
          name: Verify jq
          command: jq --version
      - run:
          name: Generate Configuration
          command: |
            if [ "<< pipeline.parameters.chain >>" = "__required__" ]; then
              echo "Generating test configuration..."
              sh validation/genesis/validation-inputs/generate-test-config.sh
              echo '{}' > .circleci/my_parameters.json
              cp .circleci/continue_config.yml .circleci/selected_continue_config.yml
            else
              echo "Generating interactive configuration..."
              echo '{ "chain_in": "<< pipeline.parameters.chain >>" }' > .circleci/my_parameters.json
              cp .circleci/continue_interactive.yml .circleci/selected_continue_config.yml
            fi
      - continuation/continue:
          configuration_path: .circleci/selected_continue_config.yml
          parameters: .circleci/my_parameters.json

workflows:
  setup:
    jobs:
      - setup-genesis-allocs-validation
